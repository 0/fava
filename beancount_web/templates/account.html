{% extends "_layout.html" %}
{% set active_page = 'trial_balance' %}

{% import '_account_macros.html' as account_macros with context %}

{% block title %}Account {{ account_name }}{% endblock %}

{% block javascript %}
    {% if not interval %}
        {% include "javascript/_journal.html" %}
    {% endif %}
{% endblock %}

{% block content %}
    {{ account_macros.account_name_header(account_name) }}

    {% if not interval %}

        {% include "charts/_chart_skeleton.html" %}

        {% with linechart_data = api.linechart_data(account_name) %}
            {% include "charts/_chart_account_balance.html" %}
        {% endwith %}

        {% with label="Monthly totals", monthly_totals=api.interval_totals('month' ,account_name) %}
            {% include "charts/_chart_monthly_totals.html" %}
        {% endwith %}

        {% set treemap_data = api.treemap_data(account_name) %}
        {% with label=treemap_data.label, rows=treemap_data.balances, modifier=treemap_data.modifier, level=account_name.split(':')|length %}
            {% include "charts/_chart_treemap.html" %}
        {% endwith %}

        <div class="headerline">
            <h3>Journal</h3>
            <h3><a href="{{ url_for('account_with_interval_balances', name=account_name, interval='year') }}">Yearly balances</a></h3>
            <h3><a href="{{ url_for('account_with_interval_balances', name=account_name, interval='month') }}">Monthly balances</a></h3>
        </div>

        {% set journal = api.journal(account_name, with_change_and_balance=True, with_journal_children=config.getboolean('journal-show-childentries')) %}
        {% with show_tablefilter=True, show_change_and_balance=True %}
            {% include "_journal_table.html" %}
        {% endwith %}

    {% elif interval == 'month' %}

        {% include "charts/_chart_skeleton.html" %}
        {% with label="Monthly totals", monthly_totals=api.interval_totals('month' ,account_name) %}
            {% include "charts/_chart_monthly_totals.html" %}
        {% endwith %}

        <div class="headerline">
            <h3><a href="{{ url_for('account_with_journal', name=account_name) }}">Journal</a></h3>
            <h3><a href="{{ url_for('account_with_interval_balances', name=account_name, interval='year') }}">Yearly balances</a></h3>
            <h3>Monthly balances</h3>
        </div>

    {% elif interval == 'year' %}

        {% include "charts/_chart_skeleton.html" %}
        {% with label="Yearly totals", yearly_totals=api.interval_totals('year', account_name) %}
            {% include "charts/_chart_yearly_totals.html" %}
        {% endwith %}

        <div class="headerline">
            <h3><a href="{{ url_for('account_with_journal', name=account_name) }}">Journal</a></h3>
            <h3>Yearly balances</h3>
            <h3><a href="{{ url_for('account_with_interval_balances', name=account_name, interval='month') }}">Monthly balances</a></h3>
        </div>
    {% endif %}

    {% if interval %}
        {% for i_treemap in interval_treemaps %}
            {% with label=i_treemap.label, rows=i_treemap.balances, modifier=i_treemap.modifier, level=account_name.split(':')|length %}
                {% include "charts/_chart_treemap.html" %}
            {% endwith %}
        {% endfor %}

        <table class="fullwidth tree-table">
            <thead>
                <tr>
                    <th>Account</th>
                    {% for end_date in interval_balances.interval_end_dates|reverse %}
                        <th>{{Â end_date.strftime(interval_format_str) }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
            {% for row in interval_balances.balances %}
                {% with account_level = account_level(row.account)  %}
                <tr data-level="{{ account_level }}" data-is-parent="{% if not row.is_leaf %}true{% else %}false{% endif %}">
                    <td class="account account-level-{{ account_level }}" data-level="{{ account_level }}">
                        <a href="{{ url_for('account_with_journal', name=row.account) }}" class="account">{{ row.account|last_segment }}</a>
                    </td>

                    {% for end_date in interval_balances.interval_end_dates|reverse %}
                        <td class="num">
                            {% if end_date.isoformat() in row.totals and row.totals[end_date.isoformat()].balances|length > 0 %}
                                <span class="balance">
                                {% for currency, number in row.totals[end_date.isoformat()].balances.items() %}
                                    {% if number %}
                                        {{ number|format_currency }} {{ currency }}<br>
                                    {% endif %}
                                {% endfor %}
                                </span>
                            {% endif %}
                            {% if end_date.isoformat() in row.totals and row.totals[end_date.isoformat()].balances_children|length > 0 %}
                                <span class="tree-balance">
                                {% for currency, number in row.totals[end_date.isoformat()].balances_children.items() %}
                                    {% if number %}
                                        {{ number|format_currency }} {{ currency }}<br>
                                    {% endif %}
                                {% endfor %}
                                </span>
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endwith %}
            {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td>&nbsp;</td>
                    {% for end_date in interval_balances.interval_end_dates|reverse %}
                        <td class="num">
                            {% for currency, number in interval_balances.totals[end_date.isoformat()].items() %}
                                {% if number %}
                                        {{ number|format_currency }} {{ currency }}<br>
                                {% endif %}
                            {% endfor %}
                        </td>
                    {% endfor %}
                </tr>
            </tfoot>
        </table>
    {% endif %}

    {% if not journal and not interval %}
        <p class="empty">
            No entries for this account{% if entry_filters %} and the applied filters{% endif %}.
        </p>
    {% endif %}
{% endblock %}
